<!DOCTYPE html>
<!--[if IE 8]>
<html lang="en" class="ie8"> <![endif]-->
<!--[if IE 9]>
<html lang="en" class="ie9"> <![endif]-->
<!--[if !IE]><!-->
<html lang="zh">
<!--<![endif]-->

<!-- BEGIN HEAD -->
<head>
    <title>居民普表年度抄表到户率查询</title>
    <base href="../../">
    <script src="../pages/scripts/basepath.js"></script>
    <script src="pages/scripts/header.js"></script>
    <meta http-equiv="content-type" content="text/html" charset="utf-8"/>

    <link rel="stylesheet" type="text/css" href="assets/global/plugins/bootstrap-select/bootstrap-select.min.css">
    <link rel="stylesheet" type="text/css" href="assets/global/plugins/select2/select2.css">
    <link href="assets/admin/pages/css/search.css" rel="stylesheet" type="text/css"/>

    <script src="pages/scripts/header.js"></script>
    <meta http-equiv="content-type" content="text/html" charset="utf-8"/>
    <link rel='stylesheet' href='assets/global/plugins/jquery-watable/watable.css'/>
    <link rel='stylesheet' href='assets/global/plugins/jquery-watable/animate.min.css'/>
    <link rel="stylesheet" type="text/css" href="assets/global/plugins/bootstrap-datepicker/css/datepicker.css"/>
    <link href='assets/global/plugins/bootstrap-datetimepicker/css/datetimepicker.css' rel='stylesheet'/>

    <link href="assets/global/css/components.css" rel="stylesheet" type="text/css"/>
    <link href="assets/global/css/plugins.css" rel="stylesheet" type="text/css"/>
    <style>
        @media print {
            .noneprint {
                display: none;
            }
        }

        .table-bordered > thead > tr > th, .table-bordered > thead > tr > td {
            border-bottom-width: 1px;
        }

        .areaName {
            padding-left: 20px !important;
            width: 250px;
            align: left !important;
        }
    </style>
    <!-- END THEME STYLES -->
</head>
<!-- END HEAD -->

<body class="page-header-fixed page-quick-sidebar-over-content">

<!-- 标题栏开始 -->
<div class="page-header navbar navbar-fixed-top">
    <script>$.include("pages/partial/menu.shtml");</script>
</div>
<!-- 标题栏结束 -->
<div class="clearfix"></div>
<div class="page-container">
    <!-- 左侧菜单开始 -->
    <div class="page-sidebar-wrapper">
        <script>$.include("pages/partial/sidebar.shtml");</script>
    </div>
    <!-- 左侧菜单结束 -->

    <!-- 主内容开始 -->
    <div class="page-content-wrapper">
        <div class="page-content">
            <!--内容头开始-->
            <script>$.include("common/navigation_bar.shtml");</script>

            <div class="container col-sm-12" style="background-color: #ffffff">
                <div class="container col-sm-12 noneprint">
                    <div class="row">
                        <div class="col-sm-3 form-group">
                            <div class="btn-group input-group">
                                <div class="input-group-addon" style="border:0px;">日期：</div>
                                <div id="div_date" class="input-group input-large date-picker input-daterange"
                                     data-date="11/2012" data-date-format="yyyy-mm">
                                    <input id="find_date" type="text" class="form-control" name="from">
                                    <span class="inputclear glyphicon glyphicon-remove-circle hidden"></span>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3 form-group">
                        </div>
                        <div class="col-sm-3 form-group">
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <button id="find_sign" type="button" class="btn yellow">
                                    查询 <i class="fa fa-search"></i>
                                </button>
                                &nbsp;&nbsp;&nbsp;&nbsp;
                                <button id="btn_print_page" onclick="window.print()" type="button"
                                        class="btn gray disabled">
                                    打印<i class="glyphicon"></i>
                                </button>
                                &nbsp;&nbsp;&nbsp;&nbsp;
                                <button id="btn_down_detail" type="button" class="btn gray disabled export-excel">
                                    导出<i class="glyphicon"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="container-fluid">
                    <div>
                        <table cellSpacing="0" cellPadding="2" width="95%" align="center" border="0">
                            <tr>
                                <td id="title" align="center" title="">居民普表年度抄表到户率查询</td>
                            </tr>
                        </table>
                    </div>
                    <br/>
                    <div>
                        <table cellSpacing="0" cellPadding="2" width="95%" align="center" border="0">
                            <tr>
                                <td id="head_r0_c1" rowspan="1" colspan="1" width="85%" align="left">

                                </td>
                                <td id="head_r0_c2" rowspan="1" colspan="1"></td>
                                <td id="head_r0_c3" rowspan="1" colspan="1"></td>
                                <td id="head_r0_c4" rowspan="1" colspan="1"></td>
                                <td id="head_r0_c5" rowspan="1" colspan="1"></td>
                                <td id="head_r0_c6" rowspan="1" colspan="1"></td>
                                <td id="head_r0_c7" rowspan="1" colspan="1"></td>
                                <td id="head_r0_c8" rowspan="1" colspan="1"></td>
                                <td id="head_r0_c9" rowspan="1" colspan="1"></td>
                                <td id="head_r0_c10" rowspan="1" colspan="1"></td>
                                <td id="head_r0_c11" rowspan="1" colspan="1"></td>
                                <td id="head_r0_c12" rowspan="1" colspan="1"></td>
                                <td id="head_r0_c13" rowspan="1" colspan="1"></td>
                                <td id="head_r0_c14" rowspan="1" colspan="1"></td>
                                <td id="head_r0_c15" rowspan="1" colspan="1" width="20%" align="right">单位:立方米／元</td>
                            </tr>
                        </table>
                    </div>
                    <div>
                        <table class="tabPrint table-hover table-condensed " align="center" width="95%" cellSpacing="0"
                               cellPadding="0" border="1"
                               ID="Table2">
                            <thead style="display:table-header-group;font-weight:bold"
                                   mce_style="display:table-header-group;font-weight:bold">
                            <tr align="center">
                                <td id="thead_r1_c1" rowspan="3" colspan="1">分公司</td>
                                <td id="thead_r1_c2" rowspan="3" colspan="1">户数</td>
                                <td id="thead_r1_c3" rowspan="3" colspan="1">抄表户数</td>
                                <td id="thead_r1_c4" rowspan="3" colspan="1">抄表率</td>
                                <td id="thead_r1_c5" rowspan="3" colspan="1">见表户数</td>
                                <td id="thead_r1_c6" rowspan="3" colspan="1">见表率</td>
                            </tr>
                            </thead>
                            <tbody id="tbody">

                            </tbody>
                        </table>
                    </div>
                    <br/>
                    <div>

                        <!--<table cellSpacing="0" cellPadding="2" width="95%" align="center" border="0">
                            <tr>
                                <td id="foot_r0_c1" rowspan="1" colspan="1">负责人：</td>
                                <td id="foot_r0_c2" rowspan="1" colspan="1" width="35%"></td>
                                <td id="foot_r0_c3" rowspan="1" colspan="1"></td>
                                <td id="foot_r0_c4" rowspan="1" colspan="1"></td>
                                <td id="foot_r0_c5" rowspan="1" colspan="1"></td>
                                <td id="foot_r0_c6" rowspan="1" colspan="1"></td>
                                <td id="foot_r0_c7" rowspan="1" colspan="1">制表人：</td>
                                <td id="foot_r0_c8" rowspan="1" colspan="1" width="15%"></td>
                                <td id="foot_r0_c9" rowspan="1" colspan="1"></td>
                                <td id="foot_r0_c10" rowspan="1" colspan="1"></td>
                                <td id="foot_r0_c11" rowspan="1" colspan="1"></td>
                                <td id="foot_r0_c12" rowspan="1" colspan="1"></td>
                                <td id="foot_r0_c13" rowspan="1" colspan="1" width="20%"></td>
                                <td id="foot_r0_c14" rowspan="1" colspan="1">填报日期：</td>
                                <td id="foot_r0_c15" rowspan="1" colspan="1"></td>
                            </tr>
                        </table>-->
                    </div>
                    <br/><br/></div>
            </div>
        </div>
    </div>
</div>
<!-- 主内容结束 -->
</div>
<script type="text/javascript">$.include("pages/partial/xwatable-form.shtml")</script>

<!-- 底边栏开始 -->
<script>$.include("pages/partial/foot.shtml");</script>
<!-- 底边栏结束 -->
</body>
<script>
    $.include("pages/partial/scripts.shtml");

</script>
<!--跳到原稿-->
<script src="../assets/global/plugins/jquery.cokie.min.js" type="text/javascript"></script>
<script type="text/javascript" src="../assets/global/plugins/jquery-watable/jquery.watable.js"></script>
<script type="text/javascript" src="../pages/scripts/rqlbuilder.js"></script>
<script type="text/javascript" src="../pages/scripts/xwatable.js"></script>
<script type="text/javascript" src="../pages/scripts/refhelper.js"></script>

<!--datapicker start-->
<script type="text/javascript" src="../assets/global/plugins/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
<script type="text/javascript"
        src="../assets/global/plugins/bootstrap-timepicker/js/bootstrap-timepicker.min.js"></script>
<script type="text/javascript" src="../assets/global/plugins/clockface/js/clockface.js"></script>
<script type="text/javascript" src="../assets/global/plugins/bootstrap-daterangepicker/moment.min.js"></script>
<script type="text/javascript" src="../assets/global/plugins/bootstrap-daterangepicker/daterangepicker.js"></script>
<script type="text/javascript"
        src="../assets/global/plugins/bootstrap-colorpicker/js/bootstrap-colorpicker.js"></script>
<script type="text/javascript"
        src="../assets/global/plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
<script src="../assets/admin/pages/scripts/components-pickers.js"></script>

<script type="text/javascript" src="../assets/global/plugins/select2/select2.js"></script>


<script src="/statement/js/libs/js-xlsx/xlsx.core.min.js" type="text/javascript"></script>
<script src="/statement/js/libs/html2canvas/html2canvas.min.js" type="text/javascript"></script>
<script src="/statement/js/tableExport.js" type="text/javascript"></script>
<script src="mods/ctm.js"></script>
<script src="mods/timeslot.js"></script>
<script src="mods/sys.js"></script>
<script src="mods/mrd.js"></script>

<!-- END PAGE LEVEL SCRIPTS -->
<script type="text/javascript">
    ComponentsPickers.init();
    var enumselectcopymonth = {
        "copy_january": {"12-26": "01-25"}, "copy_february": {"01-26": "02-25"},
        "copy_march": {"02-26": "03-25"}, "copy_april": {"03-26": "04-25"},
        "copy_may": {"04-26": "05-25"}, "copy_june": {"05-26": "06-25"},
        "copy_july": {"06-26": "07-25"}, "copy_august": {"07-26": "08-25"},
        "copy_september": {"08-26": "09-25"}, "copy_october": {"09-26": "10-25"},
        "copy_november": {"10-26": "11-25"}, "copy_december": {"11-26": "12-25"}
    };
    $(".export-excel").attr("data-table", ".tabPrint");
    //    $(".export-excel").attr("data-filename","");
    $(".export-excel").on("click", function (e) {
        e.preventDefault();
        var exportTable = $(this).data("table");
        var filename = $("#title").html();//$(this).data("filename");
        var ignoreColumn = "";//$(this).data("ignorecolumn");
        $(exportTable).tableExport({
            fileName: filename,
            type: 'excel',
            escape: 'false',
            excelstyles: ['border-bottom', 'border-top', 'border-left', 'border-right'],
            ignoreColumn: '[' + ignoreColumn + ']'
        });
    });
    var areaHelper = RefHelper.create({
        ref_url: 'gasbizarea',
        ref_col: "areaId",
        ref_display: "areaName",
    });
    $("#find_sign").click(function () {
        $("#title").html($("#find_date").val() + "居民普表抄表到户率查询");
        var start = moment($("#find_date").val() + "-26").add('month', -1).format("YYYY-MM-DD");
        var yearStart = moment(moment().add('year', -1).format("YYYY") + "-12-26").format("YYYY-MM-DD");
        var end = $("#find_date").val() + "-26";
        var reportYear = moment($("#find_date").val() + "-26").format("YYYY");
        var reportMonth = moment($("#find_date").val() + "-26").format("MM");
        console.log("年" + reportYear);
        console.log("月" + reportMonth);
        var gs = new Array();
        var tbody = "";
        var $tbody = $("#tbody");
        var bd = {
            "cols": "area_id",
            "froms": "gas_biz_area",
            "wheres": "status=1 and area_id not in('1','18','23') order by pos_code",
            "page": false
        };
        console.log(bd);
        $.ajax({
            type: 'get',
            url: '/hzqs/dbc/pbsel.do?bd=' + JSON.stringify(bd),
            dataType: 'json',
            contentType: "application/json; charset=utf-8",
            async: false,
            success: function (data) {
                for (var i = 0; i < data.rows.length; i++) {
                    if (data.rows[i].areaId) {
                        gs.push(data.rows[i].areaId);
                        tbody = tbody + '<tr align="center" data-userid="' + (4 + 1 + i) + '">' +
                                '<td id="tbody_r' + (4 + 1 + i) + '_c1" rowspan="1" colspan="1">' + areaHelper.getDisplay(gs[i]) + '</td>' +
                                '<td id="tbody_r' + (4 + 1 + i) + '_c2" rowspan="1" colspan="1"></td>' +
                                '<td id="tbody_r' + (4 + 1 + i) + '_c3" rowspan="1" colspan="1"></td>' +
                                '<td id="tbody_r' + (4 + 1 + i) + '_c4" rowspan="1" colspan="1"></td>' +
                                '<td id="tbody_r' + (4 + 1 + i) + '_c5" rowspan="1" colspan="1"></td>' +
                                '<td id="tbody_r' + (4 + 1 + i) + '_c6" rowspan="1" colspan="1"></td>' +
                                '</tr>';
                        $("#tbody").html(tbody);
                    }
                }
            }
        });
        var households;
        var oneself;
        var seemeter;
        var oneselfProportion;
        var seemeterProportion;

        for (var i = 0; i < gs.length; i++) {
            var bd1 = {
                "cols": "sum(oneself)oneself,sum(seemeter)seemeter",
                "froms": "(select ctm_archive_id," +
                "(case when  operate<>'S' and is_mrd='1' and copy_state!='9' and data_source in('01','02') and (copy_time between to_date('" + (reportYear - 1) + "-12-26 00:00:00','yyyy-mm-dd hh24:mi:ss') and to_date('" + reportYear + "-" + reportMonth + "-25 23:59:59','yyyy-mm-dd hh24:mi:ss')) then 1 else 0 end)oneself, " +
                "(case when  operate<>'S' and is_mrd='1' and copy_state!='9' and data_source='01' and (copy_time between to_date('" + (reportYear - 1) + "-12-26 00:00:00','yyyy-mm-dd hh24:mi:ss') and to_date('" + reportYear + "-" + reportMonth + "-25 23:59:59','yyyy-mm-dd hh24:mi:ss')) then 1 else 0 end)seemeter " +
                "from gas_mrd_meter_reading)t left join gas_ctm_archive a on t.ctm_archive_id=a.ctm_archive_id left join gas_ctm_meter m on a.ctm_archive_id=m.ctm_archive_id",
                "wheres": "customer_type='P' and customer_kind='1' and meter_user_state in('01','04') and a.area_id='" + gs[i] + "'",
                "page": false
            };
            console.log(bd1);
            var bd2 = {
                "cols": "sum(normal_num)households",
                "froms": "gas_report_archive",
                "wheres": "customer_kind='1' and customer_type='P' and report_year='" + reportYear + "' and report_month='" + reportMonth + "' and area_id='" + gs[i] + "'",
                "page": false
            };
            $.when(
                    $.ajax({
                        type: 'get',
                        url: '/hzqs/dbc/pbsel.do?bd=' + JSON.stringify(bd1),
                        dataType: 'json',
                        para: i,
                        contentType: "application/json; charset=utf-8",
                        success: function (data) {
                            oneself = (data.rows[0].oneself ? data.rows[0].oneself : "0");
                            $('#tbody_r' + (4 + 1 + this.para) + '_c3').html(oneself);
                            seemeter = (data.rows[0].seemeter ? data.rows[0].seemeter : "0");
                            $('#tbody_r' + (4 + 1 + this.para) + '_c5').html(seemeter);
                        }
                    }),
                    $.ajax({
                        type: 'get',
                        url: '/hzqs/dbc/pbsel.do?bd=' + JSON.stringify(bd2),
                        dataType: 'json',
                        para: i,
                        contentType: "application/json; charset=utf-8",
                        success: function (data) {
                            households = (data.rows[0].households ? data.rows[0].households : "0");
                            $('#tbody_r' + (4 + 1 + this.para) + '_c2').html(households);
                        }
                    })
            ).then(function () {
                $("#tbody").find("tr").each(function () {
                    var areaId = $(this).data("userid");
                    var c2 = $(this).find("#tbody_r" + areaId + "_c2").html();
                    var c3 = $(this).find("#tbody_r" + areaId + "_c3").html();
                    var c5 = $(this).find("#tbody_r" + areaId + "_c5").html();
                    if (parseInt(c2) == 0 && parseInt(c3) == 0) {
                        oneselfProportion = 0;
                    } else {
                        oneselfProportion = Math.round(c3 / c2 * 10000) / 100.00 ;
                    }
                    $('#tbody_r' + areaId + '_c4').html(oneselfProportion+ "%");

                    if (parseInt(c2) == 0 && parseInt(c5) == 0) {
                        seemeterProportion = 0;
                    } else {
                        seemeterProportion = Math.round(c5 / c2 * 10000) / 100.00 ;
                    }
                    $('#tbody_r' + areaId + '_c6').html(seemeterProportion+ "%");
                })
            })

        }


        var userInfo = JSON.parse(localStorage.getItem("user_info"));
//        if (userInfo.employee_name) {
//            $("#foot_r0_c8").html(userInfo.employee_name);
//        } else {
//            $("#foot_r0_c8").html("管理员");
//        }
//        $("#foot_r0_c15").html(date_format(new Date(), "yyyy-MM-dd"));
//        $("#head_r0_c1").html("制表单位:" + areaHelper.getDisplay(choseArea));
        $("#btn_down_detail").removeClass("disabled");
        $("#btn_down_detail").removeClass("gray");
        $("#btn_down_detail").addClass("green");

        $("#btn_print_page").removeClass("disabled");
        $("#btn_print_page").removeClass("gray");
        $("#btn_print_page").addClass("green");
//        });
    });
    $('#select_copy_month').on('click', '.btn', function (e) {
        var mydate = new Date();
        var fullyear = mydate.getFullYear();
        var copyids2 = this.id;
        var copyids = $(this)[0].id;
        console.log(copyids);
        var copydatetofrom = enumselectcopymonth[copyids];

        for (var x in copydatetofrom) {
            // console.log(x,a[x]);
            if (x == '12-26') {
                var yyear = (parseInt(fullyear) - 1);
                $('#find_start_month_date').val(yyear + "-" + x);

            } else {
                $('#find_start_month_date').val(fullyear + "-" + x);
            }
            $('#find_end_month_date').val(fullyear + "-" + copydatetofrom[x]);
        }

        console.log(copydatetofrom);
    })
    function date_format(date, fmt) {
        var dataJson = {
            "M+": date.getMonth() + 1, //月份
            "d+": date.getDate(), //日
            "h+": date.getHours(), //小时
            "m+": date.getMinutes(), //分
            "s+": date.getSeconds(), //秒
            "q+": Math.floor((date.getMonth() + 3) / 3), //季度
            "S": date.getMilliseconds() //毫秒
        };
        if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (date.getFullYear() + "").substr(4 - RegExp.$1.length));
        for (var k in dataJson)
            if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (dataJson[k]) : (("00" + dataJson[k]).substr(("" + dataJson[k]).length)));
        return fmt;
    }

</script>
</html>